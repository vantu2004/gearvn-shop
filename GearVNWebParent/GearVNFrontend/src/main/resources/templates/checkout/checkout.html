<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">

<!-- Head -->
<head th:replace="fragments :: page_head('Checkout', 'none')"></head>
<!-- Head -->

<body class="d-flex flex-column min-vh-100">
	<!-- Header -->
	<header th:replace="fragments :: header"></header>
	<!-- Header -->

	<div class="container mt-5 flex-grow-1">
		<h2>Checkout</h2>

		<div class="container mt-3 row">
			<!-- Left Section -->
			<div class="col-sm-8">
				<!-- Shipping Information -->
				<div class="card">
					<div class="card-header">
						<h5>Shipping Information</h5>
					</div>
					<div class="card-body">
						<p>
							<b>Ship to:</b>&nbsp; [[${fullAddress}]] <a
								th:href="@{/address_book(redirect=checkout)}">[Ship to
								another address]</a>
						</p>
						<p>
							<b>Days to deliver:</b> [[${checkoutInfo.deliverDays}]] day(s)
						</p>
						<p>
							<b>Expected delivery date:</b>
							[[${#dates.format(checkoutInfo.deliverDate, 'E, dd MMM yyyy')}]]
						</p>
					</div>
				</div>

				<!-- Payment Method -->
				<div class="card mt-3 mb-3">
					<div class="card-header">
						<h5>Payment Method</h5>
					</div>
					<div class="card-body">
						<!-- COD -->
						<div th:if="${checkoutInfo.codSupported}" class="mb-3">
							<form th:action="@{/place_order}" method="post">
								<div
									class="d-flex justify-content-between align-items-center border p-3 rounded">
									<div class="form-check">
										<input class="form-check-input" type="radio"
											name="paymentMethod" id="radioCOD" value="COD" /> <label
											class="form-check-label fw-bold" for="radioCOD"> Cash
											on Delivery (COD) </label>
									</div>
									<button class="btn btn-primary d-none" type="submit"
										id="buttonSubmit">Place Order with COD</button>
								</div>
							</form>
						</div>

						<!-- PayPal -->
						<div class="border p-3 rounded">
							<div
								class="d-flex justify-content-between align-items-center mb-2">
								<label class="form-check-label fw-bold" for="radioPayPal">
									Pay with PayPal </label>
							</div>
							<div id="paypal-button-container"></div>
							<form th:action="@{/process_paypal_order}" method="post"
								id="paypalForm">
								<input type="hidden" name="orderId" id="orderId" /> <input
									type="hidden" name="paymentMethod" value="PAYPAL" />
							</form>
						</div>
					</div>
				</div>
			</div>

			<!-- Right Section -->
			<div class="col-sm-4">
				<!-- Order Summary -->
				<div class="card">
					<div class="card-header">
						<h5>Order Summary</h5>
					</div>
					<div class="card-body">
						<table class="w-100">
							<th:block th:each="item : ${cartItems}"
								th:with="product=${item.product}">
								<tr>
									<td colspan="2"><a th:href="@{'/p/' + ${product.alias}}"
										target="_blank" class="fw-bold"> [[${product.shortName}]]
									</a></td>
								</tr>
								<tr>
									<td>x[[${item.quantity}]]</td>
									<td class="text-end"><th:block
											th:replace="fragments :: formatPriceForCheckout(${item.getTotalPrice})" />
									</td>
								</tr>
								<tr>
									<td>Ship:</td>
									<td class="text-end"><th:block
											th:replace="fragments :: formatPriceForCheckout(${item.shippingCost})" />
									</td>
								</tr>
								<tr>
									<td colspan="2"><hr /></td>
								</tr>
							</th:block>
						</table>

						<!-- Totals -->
						<div class="row mt-2">
							<div class="col">Product Total:</div>
							<div class="col text-end">
								<th:block
									th:replace="fragments :: formatPriceForCheckout(${checkoutInfo.productTotal})" />
							</div>
						</div>

						<div class="row mt-2">
							<div class="col">Shipping Total:</div>
							<div class="col text-end">
								<th:block
									th:replace="fragments :: formatPriceForCheckout(${checkoutInfo.shippingCostTotal})" />
							</div>
						</div>

						<div class="row mt-2">
							<div class="col">Payment Total:</div>
							<div class="col text-end fw-bold text-danger">
								<th:block
									th:replace="fragments :: formatPriceForCheckout(${checkoutInfo.paymentTotal})" />
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Footer -->
	<footer th:replace="fragments :: footer" class="mt-auto"></footer>
	<!-- Footer -->

	<script
		th:src="@{https://www.paypal.com/sdk/js(client-id=${paypalClientId},currency=${currencyCode})}"></script>

	<!-- jQuery Script -->
	<script type="text/javascript">
		// url
		let contextPath = "[[@{/}]]";

		// csrf
		let csrfHeader = "[[${_csrf.headerName}]]";
		let csrfValue = "[[${_csrf.token}]]";

		$(document).ready(function() {
			$("#radioCOD").on("click", function() {
				$("#buttonSubmit").removeClass("d-none");
			});
		});

		function validateOrder(orderId) {
			$("#orderId").val(orderId);
			$("#paypalForm").submit();
		}
		
		paypal.Buttons({
			// âœ… CÃ³ sáºµn: Cho phÃ©p ngÆ°á»i dÃ¹ng nháº­p thÃ´ng tin tháº» thanh toÃ¡n
			enableStandardCardFields: true,

			// âœ… CÃ³ sáºµn: HÃ m callback Ä‘á»ƒ táº¡o Ä‘Æ¡n hÃ ng khi ngÆ°á»i dÃ¹ng nháº¥n nÃºt thanh toÃ¡n
			createOrder: function (data, actions) {
				return actions.order.create({

					// âœ… CÃ³ sáºµn: Thu tiá»n ngay khi ngÆ°á»i dÃ¹ng cháº¥p thuáº­n
					intent: 'CAPTURE',

					// âœ… CÃ³ sáºµn: ThÃ´ng tin ngÆ°á»i thanh toÃ¡n
					payer: {
						name: {
							// ğŸ§‘â€ğŸ’» Tá»± Ä‘á»‹nh nghÄ©a: Láº¥y dá»¯ liá»‡u tÃªn tá»« server (Thymeleaf hoáº·c template engine)
							given_name: "[[${customer.firstName}]]",
							surname: "[[${customer.lastName}]]"
						},

						address: {
							// ğŸ§‘â€ğŸ’» Tá»± Ä‘á»‹nh nghÄ©a: ThÃ´ng tin Ä‘á»‹a chá»‰ ngÆ°á»i dÃ¹ng tá»« server
							address_line_1: "[[${customer.addressLine1}]]",
							address_line_2: "[[${customer.addressLine2}]]",
							admin_area_1: "[[${customer.state}]]",
							admin_area_2: "[[${customer.city}]]", 
							postal_code: "[[${customer.postalCode}]]",
							country_code: "[[${customer.country.code}]]"
						},

						// ğŸ§‘â€ğŸ’» Tá»± Ä‘á»‹nh nghÄ©a: Email tá»« server
						email_address: "[[${customer.email}]]",

						phone: {
							// âœ… CÃ³ sáºµn: Loáº¡i Ä‘iá»‡n thoáº¡i (MOBILE, HOME, ...); á»Ÿ Ä‘Ã¢y lÃ  di Ä‘á»™ng
							phone_type: "MOBILE",
							phone_number: {
								// ğŸ§‘â€ğŸ’» Tá»± Ä‘á»‹nh nghÄ©a: Sá»‘ Ä‘iá»‡n thoáº¡i tá»« server
								national_number: "[[${customer.phoneNumber}]]"
							}
						}
					},

					// âœ… CÃ³ sáºµn: ThÃ´ng tin Ä‘Æ¡n hÃ ng
					purchase_units: [{
						amount: {
							// ğŸ§‘â€ğŸ’» Tá»± Ä‘á»‹nh nghÄ©a: Tá»•ng sá»‘ tiá»n cáº§n thanh toÃ¡n tá»« backend
							value: "[[${checkoutInfo.getPaymentTotalForPayPal}]]",
							// ğŸ§‘â€ğŸ’» Tá»± Ä‘á»‹nh nghÄ©a: MÃ£ tiá»n tá»‡ (VD: USD, VND)
							currency_code: "[[${currencyCode}]]"
						}
					}],

					// âœ… CÃ³ sáºµn: Cáº¥u hÃ¬nh giao diá»‡n thanh toÃ¡n
					application_context: {
						// âœ… CÃ³ sáºµn: KhÃ´ng yÃªu cáº§u thÃ´ng tin giao hÃ ng
						shipping_preference: "NO_SHIPPING"
					}
				});
			},

			// âœ… CÃ³ sáºµn: Gá»i khi ngÆ°á»i dÃ¹ng cháº¥p thuáº­n thanh toÃ¡n
			onApprove: function (data, actions) {
				return actions.order.capture().then(function (details) {
					// ğŸ§‘â€ğŸ’» Tá»± Ä‘á»‹nh nghÄ©a: LÆ°u orderId vÃ  gá»i hÃ m xÃ¡c thá»±c Ä‘Æ¡n hÃ ng phÃ­a server
					orderId = details.id;
					validateOrder(orderId);
					// alert("success" + orderId + " " + "total: " + details.purchase_units[0].amount.value);
				});
			},

			// âœ… CÃ³ sáºµn: Gá»i khi ngÆ°á»i dÃ¹ng huá»· thanh toÃ¡n
			onCancel: function (data) {
				alert('Payment cancelled by the buyer');
			},

			// âœ… CÃ³ sáºµn: Gá»i khi cÃ³ lá»—i xáº£y ra trong quÃ¡ trÃ¬nh thanh toÃ¡n
			onError: function (err) {
				// ğŸ§‘â€ğŸ’» Tá»± Ä‘á»‹nh nghÄ©a: Hiá»ƒn thá»‹ lá»—i vá»›i ngÆ°á»i dÃ¹ng
				showErrorModal("Something wrong with your address information, so payment will not work.");
			}
		}).render("#paypal-button-container"); // âœ… CÃ³ sáºµn: Render nÃºt PayPal vÃ o pháº§n tá»­ cÃ³ ID tÆ°Æ¡ng á»©ng

	</script>

</body>

</html>